<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRID_01 | RECOVERY MODE</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&family=Cairo:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <style>
        :root { --accent: #00f2ff; --bg: #000; --pos: #00ffcc; --neu: #bd00ff; --neg: #ff4d00; }
        body { background: var(--bg); color: #fff; font-family: 'Space Grotesk', sans-serif; margin: 0; overflow: hidden; }
        #globe-canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        #interface { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; pointer-events: none; }
        .btn-box { pointer-events: auto; display: flex; gap: 15px; margin-top: 20px; }
        .s-btn { padding: 15px 25px; border-radius: 30px; border: 1px solid var(--accent); background: rgba(0,242,255,0.1); color: #fff; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .s-btn:hover { background: var(--accent); color: #000; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="globe-canvas"></div>

<div id="interface">
    <div id="step-1" style="pointer-events: auto;">
        <h1 style="text-align:center">GRID_01<br><span style="color:var(--accent); font-size: 14px;">[CLICK TO INITIALIZE]</span></h1>
        <button class="s-btn" onclick="toStep2()" style="margin: 20px auto; display: block;">ENTER SYSTEM</button>
    </div>

    <div id="step-2" class="hidden">
        <div class="btn-box">
            <button class="s-btn" onclick="handleVote('stable')" style="border-color:var(--pos)">STABLE</button>
            <button class="s-btn" onclick="handleVote('uncertain')" style="border-color:var(--neu)">UNCERTAIN</button>
            <button class="s-btn" onclick="handleVote('volatile')" style="border-color:var(--neg)">VOLATILE</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAafCx8E7Te1JQn-u6Zc6xbQSTo2asZR8w",
        authDomain: "grid-01-75a86.firebaseapp.com",
        projectId: "grid-01-75a86",
        databaseURL: "https://grid-01-75a86-default-rtdb.firebaseio.com/",
        storageBucket: "grid-01-75a86.firebasestorage.app",
        messagingSenderId: "277430804916",
        appId: "1:277430804916:web:fa36d92206b26393c152e1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.db = db;
    window.fbRef = ref;
    window.fbOnValue = onValue;
    window.fbTransaction = runTransaction;
</script>

<script>
    let world;

    function toStep2() {
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        initGlobe();
    }

    function initGlobe() {
        world = Globe()(document.getElementById('globe-canvas'))
            .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg')
            .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
            .atmosphereColor('#00f2ff')
            .showAtmosphere(true);

        // مراقبة البيانات فورياً
        if(window.db) {
            window.fbOnValue(window.fbRef(window.db, 'countries'), (snapshot) => {
                const data = snapshot.val() || {};
                console.log("Data received from Firebase:", data); // فحص في المتصفح
                updateColors(data);
            });
        }
    }

    function updateColors(data) {
        fetch('https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson')
            .then(res => res.json())
            .then(countries => {
                world.polygonsData(countries.features)
                    .polygonCapColor(d => {
                        const stats = data[d.properties.ISO_A2];
                        if (!stats) return 'rgba(0, 242, 255, 0.05)';
                        const max = Math.max(stats.stable || 0, stats.uncertain || 0, stats.volatile || 0);
                        if (max === 0) return 'rgba(0, 242, 255, 0.05)';
                        if (max === stats.stable) return 'rgba(0, 255, 204, 0.8)';
                        if (max === stats.uncertain) return 'rgba(189, 0, 255, 0.8)';
                        return 'rgba(255, 77, 0, 0.8)';
                    })
                    .polygonStrokeColor(() => 'rgba(0, 242, 255, 0.2)');
            });
    }

    async function handleVote(choice) {
        const countryCode = "SA"; // تجربة على السعودية أولاً
        if(window.db) {
            const cRef = window.fbRef(window.db, 'countries/' + countryCode);
            window.fbTransaction(cRef, (currentData) => {
                if (!currentData) currentData = { stable: 0, uncertain: 0, volatile: 0 };
                currentData[choice]++;
                return currentData;
            }).then(() => {
                console.log("Vote successful!");
            }).catch(err => {
                alert("Firebase Error: " + err.message);
            });
        } else {
            alert("Firebase not initialized yet!");
        }
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRID_01 | GLOBAL INTUITION RADAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&family=Cairo:wght@700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/globe.gl"></script>

    <style>
        :root { --accent: #00f2ff; --bg: #000; --pos: #00ffcc; --neu: #bd00ff; --neg: #ff4d00; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: #fff; font-family: 'Space Grotesk', sans-serif; height: 100vh; overflow: hidden; }
        
        #globe-canvas { position: fixed; top: 0; left: 0; z-index: 1; }
        
        #app-ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* نيون وهج */
        .glow-text { text-shadow: 0 0 15px var(--accent); letter-spacing: 5px; font-size: 10px; margin-bottom: 10px; color: var(--accent); }
        .hero-title { font-size: 28px; font-weight: 700; margin-bottom: 40px; text-align: center; line-height: 1.2; }

        /* النواة المركزية */
        .core-pulse {
            width: 140px; height: 140px; border-radius: 50%;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            border: 1px solid rgba(0,242,255,0.3);
            cursor: pointer; animation: pulse 3s infinite ease-in-out;
        }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 50px var(--accent); } 100% { transform: scale(1); opacity: 0.4; } }

        /* شبكة الأزرار */
        .vote-grid { display: none; gap: 20px; animation: fadeIn 1s ease forwards; }
        .v-btn {
            width: 90px; height: 90px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05); color: #fff; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 700; transition: 0.4s; backdrop-filter: blur(10px);
        }
        .v-btn:hover { transform: scale(1.1) translateY(-5px); box-shadow: 0 0 30px currentColor; }
        .stable { color: var(--pos); border-color: var(--pos); }
        .uncertain { color: var(--neu); border-color: var(--neu); }
        .volatile { color: var(--neg); border-color: var(--neg); }

        /* القوائم */
        .lang-switch { position: fixed; top: 20px; right: 20px; z-index: 100; pointer-events: auto; }
        .l-link { color: #555; text-decoration: none; font-size: 12px; margin-left: 15px; transition: 0.3s; cursor: pointer; }
        .l-link.active { color: var(--accent); font-weight: bold; }

        .legend { position: fixed; bottom: 30px; width: 100%; display: none; justify-content: center; gap: 20px; font-size: 9px; z-index: 100; letter-spacing: 2px; }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body id="mainBody">

    <div id="globe-canvas"></div>

    <nav class="lang-switch">
        <span class="l-link active" id="en-ln" onclick="setLang('en')">EN</span>
        <span class="l-link" id="ar-ln" onclick="setLang('ar')">AR</span>
    </nav>

    <main id="app-ui">
        <div id="step-1" class="interactive" style="text-align: center;">
            <p class="glow-text" id="status">CONNECTION_ESTABLISHED</p>
            <h1 class="hero-title" id="title">GRID_01:<br>GLOBAL INTUITION</h1>
            <div class="core-pulse" onclick="startApp()"></div>
        </div>

        <div id="step-2" class="vote-grid interactive">
            <button class="v-btn stable" onclick="castVote('stable')"><span id="b1">STABLE</span></button>
            <button class="v-btn uncertain" onclick="castVote('uncertain')"><span id="b2">UNCERTAIN</span></button>
            <button class="v-btn volatile" onclick="castVote('volatile')"><span id="b3">VOLATILE</span></button>
        </div>
    </main>

    <footer class="legend" id="legend">
        <div style="display:flex;align-items:center;gap:5px;"><div style="width:6px;height:6px;background:var(--pos);border-radius:50%"></div><span id="l1">STABLE</span></div>
        <div style="display:flex;align-items:center;gap:5px;"><div style="width:6px;height:6px;background:var(--neu);border-radius:50%"></div><span id="l2">UNCERTAIN</span></div>
        <div style="display:flex;align-items:center;gap:5px;"><div style="width:6px;height:6px;background:var(--neg);border-radius:50%"></div><span id="l3">VOLATILE</span></div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAafCx8E7Te1JQn-u6Zc6xbQSTo2asZR8w",
            authDomain: "grid-01-75a86.firebaseapp.com",
            projectId: "grid-01-75a86",
            databaseURL: "https://grid-01-75a86-default-rtdb.firebaseio.com/",
            storageBucket: "grid-01-75a86.firebasestorage.app",
            messagingSenderId: "277430804916",
            appId: "1:277430804916:web:fa36d92206b26393c152e1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.fbRef = ref;
        window.fbOnValue = onValue;
        window.fbTransaction = runTransaction;
    </script>

    <script>
        let world;
        let currentLang = 'en';

        function setLang(l) {
            currentLang = l;
            const isAr = l === 'ar';
            document.body.dir = isAr ? 'rtl' : 'ltr';
            document.body.style.fontFamily = isAr ? 'Cairo' : 'Space Grotesk';
            document.getElementById('status').innerText = isAr ? "تم الاتصال بنجاح" : "CONNECTION_ESTABLISHED";
            document.getElementById('title').innerHTML = isAr ? "GRID_01:<br>الحدس العالمي" : "GRID_01:<br>GLOBAL INTUITION";
            document.getElementById('b1').innerText = isAr ? "مستقر" : "STABLE";
            document.getElementById('b2').innerText = isAr ? "قلق" : "UNCERTAIN";
            document.getElementById('b3').innerText = isAr ? "مضطرب" : "VOLATILE";
            document.getElementById('l1').innerText = isAr ? "مستقر" : "STABLE";
            document.getElementById('l2').innerText = isAr ? "قلق" : "UNCERTAIN";
            document.getElementById('l3').innerText = isAr ? "مضطرب" : "VOLATILE";
            document.getElementById('en-ln').classList.toggle('active', l === 'en');
            document.getElementById('ar-ln').classList.toggle('active', l === 'ar');
        }

        function startApp() {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').style.display = 'flex';
            initGlobe();
        }

        function initGlobe() {
            world = Globe()(document.getElementById('globe-canvas'))
                .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-dark.jpg')
                .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
                .atmosphereColor('#00f2ff')
                .showAtmosphere(true)
                .atmosphereDaylightAlpha(0.15);

            window.fbOnValue(window.fbRef(window.db, 'countries'), (snapshot) => {
                const data = snapshot.val() || {};
                fetch('https://raw.githubusercontent.com/vasturiano/globe.gl/master/example/datasets/ne_110m_admin_0_countries.geojson')
                    .then(res => res.json())
                    .then(countries => {
                        world.polygonsData(countries.features)
                            .polygonCapColor(d => {
                                const stats = data[d.properties.ISO_A2];
                                if (!stats) return 'rgba(0, 242, 255, 0.05)';
                                const max = Math.max(stats.stable || 0, stats.uncertain || 0, stats.volatile || 0);
                                if (max === 0) return 'rgba(0, 242, 255, 0.05)';
                                if (max === stats.stable) return 'rgba(0, 255, 204, 0.7)';
                                if (max === stats.uncertain) return 'rgba(189, 0, 255, 0.7)';
                                return 'rgba(255, 77, 0, 0.7)';
                            })
                            .polygonStrokeColor(() => 'rgba(0, 242, 255, 0.2)')
                            .polygonLabel(({ properties: d }) => `<div style="background:rgba(0,0,0,0.8);padding:8px;border:1px solid var(--accent);">${d.NAME}</div>`);
                    });
            });
            world.controls().autoRotate = true;
            world.controls().autoRotateSpeed = 0.5;
            document.getElementById('legend').style.display = 'flex';
        }

        function castVote(choice) {
            const countryCode = "SA"; // يمكن تطويرها مستقبلاً لجلب الدولة تلقائياً
            if(window.db) {
                const cRef = window.fbRef(window.db, 'countries/' + countryCode);
                window.fbTransaction(cRef, (currentData) => {
                    if (!currentData) currentData = { stable: 0, uncertain: 0, volatile: 0 };
                    currentData[choice]++;
                    return currentData;
                });
            }
        }

        window.addEventListener('resize', () => { if(world) world.width(window.innerWidth).height(window.innerHeight); });
    </script>
</body>
</html>
